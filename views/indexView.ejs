<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyDrive</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <%- include('partials/githubButton') %>
    <%- include('partials/sidebar', { headerTitle: headerTitle, folders : rootFolders || []}) %>
    <main class="content">
        <div class="content-header">
            <%- include('partials/header', { user: user }) %>
        </div>
        
        <div class="files-container">            
            <div class="files-grid">
                <!-- Regular folders (user's own) -->
                <%if (locals.nestedFolders){ %>
                    <% nestedFolders.forEach((folder) => { %>
                        <div class="folder-item" onclick="window.location.href='/root/<%= folder.id %>'">
                            <div class="file-icon">ðŸ“‚</div>
                            <div class="file-name"><%= folder.name %></div>
                            <button class="delete-folder" onclick="event.stopPropagation(); deleteFolder('<%= folder.id %>')">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="share-folder" onclick="event.stopPropagation(); openShareModal('<%= folder.id %>', '<%= folder.name %>', 'folder')">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                    <% })%>
                <% }%>

                <!-- Shared folders (folders shared with current user) -->
                <% if (locals.sharedFolders) { %>
                    <% sharedFolders.forEach((sharedFolderRecord) => { %>
                        <div class="folder-item shared-folder" onclick="window.location.href='/root/<%= sharedFolderRecord.Folder.id %>'">
                            <div class="file-icon">ðŸ“‚</div>
                            <div class="file-name"><%= sharedFolderRecord.Folder.name %></div>
                            <button class="delete-folder" onclick="event.stopPropagation(); deleteFolder('<%= sharedFolderRecord.Folder.id %>', true)">
                                <i class="fas fa-trash"></i>
                            </button>
                            <span class="shared-indicator">Shared by <%= sharedFolderRecord.User.email %></span>
                        </div>
                    <% }); %>
                <% } %>

                <!-- Regular files (user's own) -->
                <% if (locals.files) { %>
                    <% files.forEach((file) => { %>
                        <div class="file-item" 
                        data-filename="<%= file.name %>"
                        data-size="<%= file.size %> b"
                        data-ext="<%= file.extension %>"
                        data-added="<%= file.createdAt %>"
                        data-folderid="<%= file.folderid %>"
                        data-uniqueFileName="<%= file.unique_fname %>"
                        data-encrypted="<%= file.iv ? true : false %>"
                        >
                            <div class="file-icon">ðŸ“„</div>
                            <div class="file-name"><%= file.name %><%= file.extension %></div>
                        </div>
                    <% }); %>
                <% } %>

                <!-- Shared files (files shared with current user) -->
                <% if (locals.sharedFiles) { %>
                    <% sharedFiles.forEach((sharedFile) => { %>
                        <div class="file-item shared-file" 
                        data-filename="<%= sharedFile.File.name %>"
                        data-size="<%= sharedFile.File.size %> b"
                        data-ext="<%= sharedFile.File.extension %>"
                        data-added="<%= sharedFile.File.createdAt %>"
                        data-folderid="<%= sharedFile.File.folderid %>"
                        data-uniqueFileName="<%= sharedFile.File.unique_fname %>"
                        data-encrypted="<%= sharedFile.File.iv ? true : false %>"
                        >
                            <div class="file-icon">ðŸ“„</div>
                            <div class="file-name"><%= sharedFile.File.name %><%= sharedFile.File.extension %></div>
                            <span class="shared-indicator">Shared by <%= sharedFile.User.email %></span>
                            
                        </div>
                    <% }); %>
                <% } %>
            </div>
            <% if ((!files || !files.length) && (!nestedFolders || !nestedFolders.length) ) { %>
                <% if ((!sharedFiles || !sharedFiles.length) && (!sharedFolders || !sharedFolders.length)) { %>
                    <div class="empty-state">
                        <p>No files yet. Start by uploading a file!</p>
                    </div>
                <% } else { %>
                    <div class="empty-state">
                        <p>Only the owner can edit shared files and folders</p>
                    </div>
                <% } %>
            <% } %>
        </div>
    </main>

    <!-- File Details Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">File name</h2>
                <a class="close" href="#">Ã—</a>
            </div>
            <div class="modal-body">
                <div class="file-details">
                    <div class="detail-item">
                        <span class="detail-label">Size:</span>
                        <span id="modal-size" class="detail-value">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Type:</span>
                        <span id="modal-ext" class="detail-value">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Added:</span>
                        <span id="modal-added" class="detail-value">--</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="button-section">
                    <button id="download-button" class="modal-button primary" onclick="downloadFromModal()">Download</button>
                    <button id="share-link" class="modal-button secondary" onclick="shareFromModal()" style="display: none;">Share</button>
                    <a id="delete-link" class="modal-button danger" href="#">Delete</a>
                </div>
                <div class="modal-encryption">
                    <form id="encryption-key-form">
                        <label for="encryption-key-input">Encryption Key:</label>
                        <input name="encryptionKey" id="encryption-key-input" value="" type="text"/>
                    </form>
                    <small class="modal-encryption-note"></small>
                </div>
                <div id="download-error" style="color: red; margin: 1em 0;"></div>
            </div>
        </div>
    </div>

    <!-- Include Share Modal -->
    <%- include('partials/shareModal') %>
    
    <!-- Include JavaScript files -->
    <script type="module" src="/js/importKey.js"></script>
    <script src="/js/shareModal.js"></script>
    <script type="module" src="/js/index.js"></script>
    <script type="module" src="/js/decryptFile.js"></script>
</body>
</html>