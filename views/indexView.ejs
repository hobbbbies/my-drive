<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyDrive</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <%- include('partials/sidebar', { headerTitle: headerTitle, folders: rootFolders|| []}) %>
    <main class="content">
        <div class="content-header">
            <%- include('partials/header', { user: user}) %>
        </div>
        
        <div class="files-container">
            <!-- Future implentation: path will be rendered here -->
                <% if (locals.chosenFolder) { %>
                    <p><%= chosenFolder.name %></p>
                <% } %>
                <div class="files-grid">
                    <%if (locals.nestedFolders){ %>
                        <% nestedFolders.forEach((folder) => { %>
                            <div class="folder-item" onclick="window.location.href='/root/<%= folder.id %>'">
                                <div class="file-icon">ðŸ“‚</div>
                                <div class="file-name"><%= folder.name %></div>
                                <button class="delete-folder" onclick="event.stopPropagation(); deleteFolder('<%= folder.id %>')">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="share-folder" onclick="event.stopPropagation(); openShareModal('<%= folder.id %>', '<%= folder.name %>', 'folder')">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                            </div>
                        <% })%>
                    <% }%>
                    <% if (locals.files) { %>
                        <% files.forEach((file) => { %>
                            <div class="file-item" 
                            data-filename="<%= file.name %>"
                            data-id="<%= file.id %>"
                            data-size="<%= file.size %>"
                            data-ext="<%= file.extension %>"
                            data-added="<%= file.createdAt %>"
                            data-folderid="<%= file.folderid %>"
                            data-storagePath="<%= file.storagePath %>"
                            >
                                <div class="file-icon">ðŸ“„</div>
                                <div class="file-name"><%= file.name %></div>
                                <button class="share-file" onclick="event.stopPropagation(); openShareModal('<%= file.id %>', '<%= file.name %>', 'file')">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                            </div>
                        <% }); %>
                    <% } %>
                </div>
                <% if ((!files || !files.length) && (!nestedFolders || !nestedFolders.length)) { %>
                    <div class="empty-state">
                        <p>No files yet. Start by uploading a file!</p>
                    </div>
                <% } %>
        </div>
    </main>

    <!-- File Details Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">File name</h2>
                <a class="close" href="#">Ã—</a>
            </div>
            <div class="modal-body">
                <div class="file-details">
                    <div class="detail-item">
                        <span class="detail-label">Size:</span>
                        <span id="modal-size" class="detail-value">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Type:</span>
                        <span id="modal-ext" class="detail-value">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Added:</span>
                        <span id="modal-added" class="detail-value">--</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="download-link" class="modal-button primary" href="#">Download</a>
                <a id="delete-link" class="modal-button danger" href="#">Delete</a>
            </div>
        </div>
    </div>

    <!-- Include Share Modal -->
    <%- include('partials/shareModal') %>

    <!-- Include JavaScript files -->
    <script src="/js/shareModal.js"></script>
    <script>
        // File details modal functionality
        const modal = document.getElementById("modal");
        const modalTitle = document.getElementById("modal-title");
        const modalSize = document.getElementById("modal-size");
        const modalExt = document.getElementById("modal-ext");
        const modalAdded = document.getElementById("modal-added");
        const downloadLink = document.getElementById("download-link");
        const deleteLink = document.getElementById("delete-link");
        const fileItems = document.querySelectorAll(".file-item");
        const closeBtn = document.querySelector(".close");

        fileItems.forEach((item) => {
            item.onclick = (e) => {
                // Don't open modal if clicking on share button
                if (e.target.closest('.share-file')) return;
                
                // Get file metadata from data attributes
                const fileName = item.getAttribute("data-filename");
                const fileSize = item.getAttribute("data-size");
                const fileExt = item.getAttribute("data-ext");
                const fileAdded = item.getAttribute("data-added");
                const fileid = item.getAttribute("data-id");
                const folderid = item.getAttribute("data-folderid");
                const storagePath = item.getAttribute("data-storagePath");
                
                const trimmedAdded = new Date(fileAdded).toLocaleDateString();
                // Update modal content
                modalTitle.textContent = fileName;
                modalSize.textContent = fileSize || "--";
                modalExt.textContent = fileExt || "--";
                modalAdded.textContent = trimmedAdded || "--";

                downloadLink.setAttribute("href", `/download/?id=${fileid}`);
                deleteLink.setAttribute("href", `/delete/?id=${fileid}`);

                // Show the modal
                modal.style.display = "block";
            };
        });

        closeBtn.onclick = (e) => {
            e.preventDefault();
            modal.style.display = "none";
        };

        // Close modal when clicking outside the content
        window.onclick = (event) => {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        };

        function deleteFolder(folderId) {
            if (confirm('Are you sure you want to delete this folder? This action cannot be undone.')) {
                window.location.href = `/folder/delete/?id=${folderId}`;
            }
        }
    </script>
</body>
</html>